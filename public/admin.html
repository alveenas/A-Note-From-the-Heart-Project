<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin</title>
  <style>
    body{font-family:sans-serif;padding:20px;background:#f5f5f5}
    input,button{padding:8px;margin:4px}
    .note{border:1px solid #ccc;padding:12px;margin:10px 0;background:white}
    .hidden{opacity:.4}
    .tags{margin-top:6px}
    .tag{
      display:inline-block;
      margin:2px 6px 2px 0;
      font-size:12px;
    }
  </style>
</head>
<body>

<h2>Admin Portal</h2>

<input id="password" type="password" placeholder="Admin password">
<button onclick="load()">Load Data</button>

<h3>Notes</h3>
<div id="notes"></div>

<h3>Feedback</h3>
<div id="feedback"></div>

<script>
const ALL_TAGS = ["kindness","motivational","silly","love","sad","hope"];

function headers(){
  return {
    "Content-Type":"application/json",
    "x-admin-password": document.getElementById("password").value.trim()
  };
}

function load(){
  fetch("/admin/data",{headers:headers()})
    .then(r=>{
      if(!r.ok) throw "unauthorized";
      return r.json();
    })
    .then(d=>{
      notes.innerHTML="";
      d.notes.forEach(n=>{
        const div=document.createElement("div");
        div.className="note"+(n.hidden?" hidden":"");

        let tagHtml = "";
        ALL_TAGS.forEach(t=>{
          const checked = (n.tags || []).includes(t) ? "checked" : "";
          tagHtml += `
            <label class="tag">
              <input type="checkbox" ${checked}
                onchange="updateTags(${n.id})"
                data-id="${n.id}"
                value="${t}">
              ${t}
            </label>
          `;
        });

        div.innerHTML=`
          <b>${n.title || "(no title)"}</b><br>
          ${n.message}<br><br>
          reports: ${n.reportcount}<br>

          <div class="tags">
            <b>Tags:</b><br>
            ${tagHtml}
          </div><br>

          <button onclick="toggle(${n.id},${!n.hidden})">
            ${n.hidden?"Unhide":"Hide"}
          </button>
          <button onclick="del(${n.id})">Delete</button>
        `;
        notes.appendChild(div);
      });

      feedback.innerHTML="";
      d.feedback.forEach(f=>{
        feedback.innerHTML+=`
          <div class="note">${f.message}</div>
        `;
      });
    })
    .catch(()=>alert("Wrong password"));
}

function toggle(id,val){
  fetch("/admin/toggleHidden",{
    method:"POST",
    headers:headers(),
    body:JSON.stringify({noteId:id,hidden:val})
  }).then(load);
}

function del(id){
  if(!confirm("Delete permanently?")) return;
  fetch("/admin/delete",{
    method:"POST",
    headers:headers(),
    body:JSON.stringify({noteId:id})
  }).then(load);
}

function updateTags(id){
  const checkboxes = document.querySelectorAll(
    `input[data-id="${id}"]:checked`
  );
  const tags = [...checkboxes].map(c=>c.value);

  fetch("/admin/updateTags",{
    method:"POST",
    headers:headers(),
    body:JSON.stringify({noteId:id,tags})
  });
}
</script>

</body>
</html>
