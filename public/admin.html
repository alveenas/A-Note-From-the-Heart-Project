<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin</title>
  <style>
    body{font-family:sans-serif;padding:20px;background:#f5f6fa}
    input,button{padding:6px;margin:4px}
    .note{
      border:1px solid #ccc;
      padding:10px;
      margin:10px 0;
      background:white;
      border-radius:8px;
    }
    .hidden{opacity:.4}
    .tags{margin-top:6px}
    .tag{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      background:#eee;
      margin:2px;
      font-size:12px;
    }
  </style>
</head>
<body>

<h2>Admin Portal</h2>

<input id="password" type="password" placeholder="Admin password">
<button onclick="load()">Load Data</button>

<h3>Notes</h3>
<div id="notes"></div>

<h3>Feedback</h3>
<div id="feedback"></div>

<script>
function headers(){
  return {
    "Content-Type":"application/json",
    "x-admin-password": document.getElementById("password").value.trim()
  };
}

function load(){
  fetch("/admin/data",{headers:headers()})
    .then(r=>{
      if(!r.ok) throw "unauthorized";
      return r.json();
    })
    .then(d=>{
      notes.innerHTML="";
      d.notes.forEach(n=>{
        const div=document.createElement("div");
        div.className="note"+(n.hidden?" hidden":"");

        const tagString = (n.tags || []).join(", ");

        div.innerHTML=`
          <b>${n.title}</b><br>
          ${n.message}<br><br>

          reports: ${n.reportcount}<br>

          tags:
          <input id="tags-${n.id}" value="${tagString}" placeholder="kindness, hope, sad"><br>

          <button onclick="saveTags(${n.id})">Save Tags</button>
          <button onclick="toggle(${n.id},${!n.hidden})">${n.hidden?"Unhide":"Hide"}</button>
          <button onclick="del(${n.id})">Delete</button>
        `;
        notes.appendChild(div);
      });

      feedback.innerHTML="";
      d.feedback.forEach(f=>{
        feedback.innerHTML+=`<div class="note">${f.message}</div>`;
      });
    })
    .catch(()=>alert("Wrong password"));
}

function saveTags(id){
  const raw = document.getElementById("tags-"+id).value;
  const tags = raw.split(",").map(t=>t.trim()).filter(Boolean);

  fetch("/admin/updateTags",{
    method:"POST",
    headers:headers(),
    body:JSON.stringify({ noteId:id, tags })
  }).then(()=>{
    alert("Tags saved");
    load();
  });
}

function toggle(id,val){
  fetch("/admin/toggleHidden",{
    method:"POST",
    headers:headers(),
    body:JSON.stringify({noteId:id,hidden:val})
  }).then(load);
}

function del(id){
  if(!confirm("Delete permanently?")) return;
  fetch("/admin/delete",{
    method:"POST",
    headers:headers(),
    body:JSON.stringify({noteId:id})
  }).then(load);
}
</script>

</body>
</html>
